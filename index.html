<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Blob Tracking – p5.js + OpenCV.js</title>

  <!-- p5.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>
  <!-- OpenCV.js -->
  <script async src="https://docs.opencv.org/4.x/opencv.js" onload="cvOnLoad()"></script>
  <!-- JSZip per sequenze ZIP -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

  <style>
    :root{
      color-scheme: dark;
      --bg:#0f1115; --panel:#151922; --muted:#8892a6; --line:#252b36;
      --topbar-h:56px; --radius:12px; --touch:44px;
    }
    *{ box-sizing:border-box }
    html, body { height: 100%; }
    body{
      margin:0; background:var(--bg); color:#e5e9f0);
      color:#e5e9f0; font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
    }
    body.no-scroll { overflow:hidden; }

    /* Topbar mobile/desktop */
    .topbar{
      position: sticky; top: 0; z-index: 50;
      height: var(--topbar-h);
      display:flex; align-items:center; gap:10px;
      padding:8px 12px; background:#0b1018; border-bottom:1px solid var(--line);
    }
    .topbar h1{ margin:0; font-size:16px; font-weight:600; }
    .topbar #menuToggle{
      width:var(--touch); height:var(--touch);
      display:inline-grid; place-items:center;
      border:1px solid var(--line); border-radius:var(--radius);
      background:#0f1724; color:#e5e9f0; font-size:18px; cursor:pointer;
    }

    /* Layout desktop di base */
    #app{
      display:grid; grid-template-columns:320px 1fr;
      height: calc(100dvh - var(--topbar-h));
    }
    #sidebar{
      background:var(--panel); border-right:1px solid var(--line);
      overflow:auto; padding:16px 14px;
    }
    #sidebar h1{ margin:0 0 10px; font-size:18px; }
    .sub{ color:var(--muted); font-size:12px; margin-bottom:10px; }
    details{ border:1px solid var(--line); border-radius:12px; margin-bottom:10px; background:#10141d; }
    summary{ cursor:pointer; list-style:none; padding:10px 12px; font-weight:600; }
    summary::-webkit-details-marker{ display:none }
    .section{ padding:8px 12px 12px; display:grid; gap:8px; }
    .row{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
    .label{ min-width:120px; color:var(--muted) }
    .row input[type="range"]{ width:160px }
    .row input[type="color"]{ width:40px; height:28px; padding:0; border:0; background:none }
    select, input[type="file"], input[type="text"], input[type="range"], button, input[type="number"], input[type="checkbox"]{
      background:#0c1018; border:1px solid var(--line); color:#e5e9f0; border-radius:8px; padding:6px 8px;
    }
    button.primary{ background:#0f1724; border-color:#2b3447; }

    #stage{ display:flex; flex-direction:column; min-width:0; }
    #stageToolbar{
      display:flex; align-items:center; justify-content:space-between;
      padding:10px 14px; border-bottom:1px solid var(--line);
      background:#0e131c; gap:10px;
    }
    #stageToolbar .right{ color:#9aa3b2; font-size:12px; }

    #canvasWrap{
      position:relative; flex:1; min-height:0;
      display:flex; align-items:flex-start; justify-content:center;
      overflow:auto; background:#0b0f16; padding:0;
    }
    #canvasWrap canvas{ display:block; max-width:100%; height:auto; }

    /* ---------- MOBILE: sidebar come drawer sotto la topbar ---------- */
    @media (max-width: 900px){
      #app{
        grid-template-columns: 1fr;
        height: calc(100dvh - var(--topbar-h));
      }
      /* Trasforma la sidebar in un pannello a scomparsa */
      #sidebar{
        position: fixed; left:0; right:0; top: var(--topbar-h); bottom: 0;
        transform: translateY(-110%);
        transition: transform .25s ease;
        border-right:none; border-bottom:1px solid var(--line);
        border-radius: 0 0 var(--radius) var(--radius);
        z-index: 40;
        max-height: none;
      }
      #sidebar.open{ transform: translateY(0); }
      /* Migliora target touch */
      summary{ padding:12px 14px; }
      select, input[type="file"], input[type="text"], input[type="range"], button, input[type="number"], input[type="checkbox"]{
        min-height: var(--touch);
      }
    }
  </style>
</head>
<body>
  <!-- Topbar con hamburger -->
  <header class="topbar">
    <button id="menuToggle" aria-label="Apri/chiudi impostazioni">☰</button>
    <h1>Blob Tracking</h1>
  </header>

  <div id="app">
    <aside id="sidebar">
      <h1>Blob Tracking</h1>
      <div class="sub">p5.js + OpenCV.js – sidebar sinistra, canvas destra</div>

      <details open>
        <summary>Sorgente</summary>
        <div class="section">
          <div class="row"><button id="btnWebcam" class="primary">Webcam</button></div>
          <div class="row"><button id="btnSwitchCam">Cambia camera</button></div>
          <div class="row"><span class="label">Immagine</span><input id="fileImg" type="file" accept="image/*"></div>
          <div class="row"><span class="label">Video</span><input id="fileVid" type="file" accept="video/*"></div>
        </div>
      </details>

      <details open>
        <summary>Rilevamento</summary>
        <div class="section">
          <div class="row"><span class="label">Metodo</span>
            <select id="method"><option value="threshold">Threshold</option><option value="canny">Canny</option></select>
          </div>
          <div class="row" id="thLabel"><span class="label">Threshold</span><input id="thresh" type="range" min="0" max="255" step="1" value="100"></div>
          <div class="row" id="cxLabel" style="display:none"><span class="label">Canny low</span><input id="cannyL" type="range" min="0" max="255" step="1" value="50"></div>
          <div class="row" id="cyLabel" style="display:none"><span class="label">Canny high</span><input id="cannyH" type="range" min="0" max="255" step="1" value="150"></div>
          <div class="row"><span class="label">Blur</span><input id="blur" type="range" min="0" max="25" step="1" value="5"></div>
          <div class="row"><label><input id="approx" type="checkbox" checked> Semplifica contorni</label></div>
          <div class="row"><label><input id="features" type="checkbox"> Box + centroidi</label></div>
          <div class="row"><span class="label">Area minima</span><input id="minArea" type="range" min="0" max="50000" step="100" value="1500"><output id="minAreaVal">1500</output></div>
        </div>
      </details>

      <details open>
        <summary>Stile contorni</summary>
        <div class="section">
          <div class="row"><span class="label">Spessore max</span><input id="maxStroke" type="range" min="1" max="12" step="1" value="6"><output id="maxStrokeVal">6</output></div>
          <div class="row"><label><input id="useColormap" type="checkbox" checked> Usa colormap</label></div>
          <div class="row"><span class="label">Colormap</span>
            <select id="colormap"><option value="bluered">Blu → Rosso</option><option value="viridis">Viridis</option><option value="plasma">Plasma</option></select>
          </div>
          <div class="row"><span class="label">Colore fisso</span><input id="fixedColor" type="color" value="#00ff66"></div>
          <div class="row"><span class="label">Opacità</span><input id="strokeAlpha" type="range" min="20" max="255" step="1" value="220"></div>
        </div>
      </details>

      <details>
        <summary>Colori UI</summary>
        <div class="section">
          <div class="row"><span class="label">Box</span><input id="boxColor" type="color" value="#00d1ff"></div>
          <div class="row"><span class="label">Centroide</span><input id="centroidColor" type="color" value="#00d1ff"></div>
          <div class="row"><span class="label">Linea etichetta</span><input id="labelLineColor" type="color" value="#ffffff"></div>
          <div class="row"><span class="label">Testo</span><input id="labelTextColor" type="color" value="#ffffff"></div>
          <div class="row"><label><input id="labelBg" type="checkbox"> Sfondo testo</label></div>
        </div>
      </details>

      <details>
        <summary>Etichette & Metriche</summary>
        <div class="section">
          <div class="row"><label><input id="labels" type="checkbox"> Mostra etichette</label></div>
          <div class="row"><span class="label">Metrica</span>
            <select id="labelMetric"><option value="coords">Coordinate (x,y)</option><option value="index">Indice punto</option><option value="dist">Distanza dal centroide</option><option value="curv">Curvatura locale</option><option value="area">Area del blob</option></select>
          </div>
          <div class="row"><span class="label">Step punti</span><input id="labelStep" type="range" min="5" max="80" step="1" value="30"><output id="labelStepVal">30</output></div>
          <div class="row" id="curvWinLabel"><span class="label">Finestra curv.</span><input id="curvWin" type="range" min="1" max="20" step="1" value="6"><output id="curvWinVal">6</output></div>
          <div class="row"><span class="label">Font size</span><input id="fontSize" type="range" min="10" max="36" step="1" value="16"><output id="fontSizeVal">16</output></div>
          <div class="row"><span class="label">Template</span><input id="labelTemplate" type="text" placeholder="{x}, {y}"></div>
          <div class="row"><span class="label">Decimali</span><input id="decimals" type="range" min="0" max="4" step="1" value="1"><output id="decimalsVal">1</output></div>
          <div class="row"><span class="sub">Segnaposto: {x} {y} {index} {dist} {curv} {area}</span></div>
        </div>
      </details>

      <details open>
        <summary>Export</summary>
        <div class="section">
          <div class="row"><span class="label">PNG scala</span>
            <select id="pngScale"><option value="1">1×</option><option value="2">2×</option><option value="4">4×</option></select>
          </div>
          <div class="row"><label><input id="overlayOnly" type="checkbox"> Solo overlay (trasparente)</label></div>
          <div class="row"><button id="btnPng">📷 Salva PNG</button></div>
          <hr style="border:0;border-top:1px solid var(--line);width:100%">
          <div class="row"><span class="label">Sequenza</span>
            <input id="seqSeconds" type="number" min="1" value="3" style="width:70px"> s
            <span class="label" style="min-width:auto;margin-left:8px">FPS</span>
            <input id="seqFps" type="number" min="1" max="60" value="12" style="width:70px">
          </div>
          <div class="row"><span class="label">Scala</span>
            <select id="seqScale"><option value="1">1×</option><option value="2">2×</option></select>
          </div>
          <div class="row"><label><input id="seqOverlayOnly" type="checkbox"> Solo overlay</label></div>
          <div class="row"><button id="btnSeq">🗂️ Esporta sequenza (ZIP)</button></div>
          <hr style="border:0;border-top:1px solid var(--line);width:100%">
          <div class="row"><span class="label">WebM FPS</span>
            <input id="webmFps" type="number" min="5" max="60" value="30" style="width:70px">
          </div>
          <div class="row"><button id="btnWebmStart">⏺️ Start WebM</button><button id="btnWebmStop" disabled>⏹️ Stop</button></div>
        </div>
      </details>
    </aside>

    <main id="stage">
      <div id="stageToolbar">
        <div class="btnbar">
          <span id="infoSource">Sorgente: —</span>
        </div>
        <div class="right"><span id="infoFps">FPS: —</span></div>
      </div>
      <div id="canvasWrap"></div>
    </main>
  </div>

  <script>
    let cvReady = false;
    function cvOnLoad(){ if (typeof cv !== 'undefined') cv.onRuntimeInitialized = () => cvReady = true; }
  </script>

  <!-- Toggle sidebar su mobile -->
  <script>
    (function () {
      const btn = document.getElementById('menuToggle');
      const sidebar = document.getElementById('sidebar');
      if (!btn || !sidebar) return;
      btn.addEventListener('click', () => {
        sidebar.classList.toggle('open');
        document.body.classList.toggle('no-scroll');
      });
    })();
  </script>

  <script src="sketch.js" defer></script>
</body>
</html>
